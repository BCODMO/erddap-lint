<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>ERDDAP-lint tests</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://unpkg.com/mocha/mocha.css" />
      <script src="js/erddap-lint.js"></script>
  </head>
  <body>
    
    <div id="mocha">
      <h1><a href="index.html">ERDDAP-lint tool</a></h1>
      <small><small><pre id="status"></pre></small></small><h1 id="title"></h1></div>

    <script src="https://unpkg.com/chai/chai.js"></script>
    <script src="https://unpkg.com/mocha/mocha.js"></script>

    <script class="mocha-init">
      mocha.setup('bdd');
      //mocha.growl(); // <-- Enables web notifications
      mocha._reporter.prototype.testURL = function(test){return `#${window.location.hash.substring(1)}`};
      mocha._reporter.prototype.suiteURL = function(suite){
        let link = suite.link || `#${window.location.hash.substring(1)}`;
        return `?${new Date().getTime()}${link}`;
      };
    </script>
<script>
    let setTitle = function(erddap){
      erddap = erddap.replace(/\/info\/.*$/,"");
      document.getElementById("title").innerHTML = `<a href="?${new Date().getTime()}#erddap=${erddap}">${erddap}</a>`;
    }
    let params = window.location.hash.substring(1).split('&').reduce((h,hk) => { 
      let t = hk.split('='); 
        h[t[0]] = t[1];
        return h;
    },{});
    let rules = (params.rules && params.rules.split("|"))||[];

    let getErddapLint = function(){
      let t = new Date().getTime();
      return fetch("rules/index.html").then(r=>r.text()).then(html=>{
        let el = document.createElement("div");
        el.innerHTML = html;
        let ruleUrls = Array.prototype.map.call(el.querySelectorAll("A"), 
            (e)=> e.getAttribute('href')).filter(url=>rules.length==0||rules.indexOf(url.replace(/.md$/,""))>=0).map(url=>new URL(`rules/${url}?${t}`,document.baseURI).href);
        let lint = new ErddapLint();
        return lint.fetchRules(ruleUrls).then(_=>lint);
      });
    }
    let statusel = document.getElementById("status");
    let statuscb = function(status){
      statusel.innerText = status?"Testing...\n"+status:"";
    };
    if(params.dataset){
      setTitle(params.dataset);
      getErddapLint().then(lint=>{
        lint.prepareMochaTestsForDataset(params.dataset, undefined, statuscb)
          .then(e=>{
            mocha.run(()=>statusel.innerText = "");
          })
        });
    }else if(params.erddap){
      setTitle(params.erddap);
      getErddapLint().then(lint=>{
              lint.prepareMochaTestsForErddap(params.erddap, statuscb)
                .then(e=>{
                  mocha.run(()=>statusel.innerText = "");
                })
              });
    }else{
      //redirect to index.
        let index = new URL("index.html",document.baseURI).href
        window.location.href = index;
    }

</script>

  </body>
</html>
